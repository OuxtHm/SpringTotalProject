pipeline {
    agent any
    
    environment {
        // ë„ì»¤ í—ˆë¸Œ ì´ë¯¸ì§€ ê²½ë¡œ
        DOCKER_IMAGE = "ouxthm/total-app:latest"
        // ì  í‚¨ìŠ¤ Credentialsì— ë“±ë¡í•œ ID
        DOCKER_HUB_CREDS = 'dockerhub-creds'
        // ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì • íŒŒì¼ ê²½ë¡œ
        KUBE_CONFIG = "/home/sist/.kube/config"
        // deployment.yaml íŒŒì¼ ìœ„ì¹˜
        K8S_YAML = "/var/lib/jenkins/k8s/deployment.yaml"
    }
        
    stages {
        // 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        stage('Check Out') {
            steps {
                echo 'Git Checkout'
                checkout scm
            }
        }
        
        // 2. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        stage('Gradle Permission') {
            steps {
                sh 'chmod +x gradlew'
            }
        }
        
        // 3. ì´ì „ ë¹Œë“œ ê¸°ë¡ ì‚­ì œ í›„ ìƒˆë¡œ ë¹Œë“œ (ì†ŒìŠ¤ ë°˜ì˜ ë³´ì¥)
        stage('Gradle Build') {
            steps {
                sh './gradlew clean build'
            }
        }
        
        // 4. ë„ì»¤ ë¡œê·¸ì¸ & ë¹Œë“œ & í‘¸ì‹œ (í•œ ë‹¨ê³„ë¡œ ë¬¶ì–´ ì²˜ë¦¬)
        stage('Docker Build & Push') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: "${DOCKER_HUB_CREDS}",
                    usernameVariable: 'DH_USER',
                    passwordVariable: 'DH_PASS'
                )]) {
                    sh '''
                        # ë„ì»¤ ë¡œê·¸ì¸
                        echo "$DH_PASS" | docker login -u "$DH_USER" --password-stdin
                        
                        # ìºì‹œ ì—†ì´ ë¹Œë“œ (HTML ë³€ê²½ ì‚¬í•­ ë°˜ì˜ ë³´ì¥)
                        docker build --no-cache -t ${DOCKER_IMAGE} .
                        
                        # ë„ì»¤ í—ˆë¸Œë¡œ ì´ë¯¸ì§€ ì „ì†¡
                        docker push ${DOCKER_IMAGE}
                    '''
                }
            }
        }
        
        // 5. ë¯¸ë‹ˆì¿ ë² ì— ë°°í¬ ë° ê°•ì œ ì¬ì‹œì‘
        stage('Deploy to MiniKube') {
            steps {
                sh """
                    # 1. ìƒˆë¡œìš´ ì„¤ì • ì ìš© (sist ê³„ì • ê¶Œí•œ ì‚¬ìš©)
                    sudo -u sist /usr/local/bin/kubectl apply -f ${K8S_YAML}
                    
                    # 2. ğŸ”¥ í•µì‹¬: ìƒˆ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œë°›ë„ë¡ Pod ê°•ì œ ì¬ì‹œì‘
                    sudo -u sist /usr/local/bin/kubectl rollout restart deployment/totalapp-deployment
                    
                    # 3. ë°°í¬ ì™„ë£Œë  ë•Œê¹Œì§€ ìƒíƒœ í™•ì¸
                    sudo -u sist /usr/local/bin/kubectl rollout status deployment/totalapp-deployment --timeout=90s
                    
                    # 4. ìµœì¢… Pod ìƒíƒœ ì¶œë ¥
                    sudo -u sist /usr/local/bin/kubectl get pods
                """
            }
        }
    }
}